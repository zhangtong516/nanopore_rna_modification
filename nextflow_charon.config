// Nextflow configuration file
params {
    // run params
    output_dir = "./results"
    threads = 8  // Add this line

    // params for prepare_input
    chunk_size = 4000 

    // params for dorado basecaller 
    min_qscore = 7
    kit_name = "SQK-RNA004"
    dorado_model_dir = "${baseDir}/resources/dorado_models/"
    dorado_rna_model = "rna004_130bps_sup@v5.2.0"
    dorado_model = "sup"
    dorado_mods_models = "pseU_2OmeU,2OmeG,m5C_2OmeC,inosine_m6A_2OmeA"

    // programs
    dorado = "/home/users/astar/gis/zhangt/Software/bin/dorado"
    modkit = "/home/users/astar/gis/zhangt/Software/bin/modkit"
    minimap2 = "/home/users/astar/gis/zhangt/miniforge/bin/minimap2"
    samtools = "/home/users/astar/gis/zhangt/miniforge/bin/samtools" 

}
// Process configuration
process {
    // Default process configuration
    executor = 'slurm'
    clusterOptions = { ' -V --partition=cpu ' }  // Remove account specification or update with your actual account
    penv = 'OpenMP'
    // errorStrategy = { task.attempt < 2 ? 'retry' : 'finish' }
    pollInterval = '30 sec'
    exitReadTimeout = "120 sec"
    
    // Process-specific configurations
    withName: DORADO_BASECALL {
        cpus = 8
        memory = '32 GB'
        time = '12h'
        accelerator = 1
        container = 'ontresearch/dorado:latest'
        containerOptions = '--gpus all --shm-size=8g'
        clusterOptions = '-V --partition=gpu4w --gres=gpu:1'  // Request 1 GPU explicitly
    }
    
    withName: MINIMAP2_ALIGNMENT {
        cpus = 8
        memory = '32 GB'
        time = '6h'
    }
    
    withName: MODIFICATION_ANALYSIS {
        cpus = 4
        memory = '16 GB'
        time = '4h'
        container = 'ontresearch/modkit:latest'
    }
}

// Docker configuration
docker {
    enabled = false
    runOptions = '--gpus all --shm-size=8g'
}

// Singularity configuration (alternative to Docker)
singularity {
    enabled = true
    autoMounts = true
}

// Resource limits
executor {
    queueSize = 10
    submitRateLimit = '1 sec'
}

// Reporting
report {
    enabled = true
    file = "${params.output_dir}/reports/nextflow_report.html"
}

timeline {
    enabled = true
    file = "${params.output_dir}/reports/timeline.html"
}

trace {
    enabled = true
    file = "${params.output_dir}/reports/trace.txt"
}